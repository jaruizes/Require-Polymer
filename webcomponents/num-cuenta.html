<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
<dom-module id="num-cuenta">

    <style>
        input.invalid {
            border:1px solid #f00;
        }
    </style>

    <template>
        <div id="numcuentacomponent">
            <label>{{label}}</label>
            <input type="text" id="entidad" class="cuenta" size="4" maxlength="4" placeholder="1234"
                   value="{{entidad::blur}}">&nbsp;
            <input type="text" id="oficina" class="cuenta" size="4" maxlength="4" placeholder="1234"
                   value="{{oficina::blur}}">&nbsp;
            <input type="text" id="dc" class="cuenta" size="2" maxlength="2" placeholder="12"
                   value="{{dc::blur}}">&nbsp;
            <input type="text" id="numcuenta" class="cuenta" size="10" maxlength="10" placeholder="1234567890"
                   value="{{cuenta::keyup}}">
        </div>
        <div id="msg"></div>

    </template>


</dom-module>

<script>
    var fieldsOK = [false, false, false, false];
    function _validarCampo (fieldId, value, maxlength) {
        fieldsOK[fieldId] = value && value.length == maxlength && !isNaN(value);
        if (fieldsOK[0] && fieldsOK[1] && fieldsOK[2] && fieldsOK[3]) {
            _validar();
        }

        function _validar() {
            var entidad = $('#entidad');
            var sucursal = $('#sucursal');
            var dc = $('#dc');
            var cuenta = $('#numcuenta');

            if (entidad && sucursal && dc && cuenta) {
                if (!(obtenerDigito("00" + entidad.val() + sucursal.val()) ==
                        parseInt(dc.val().charAt(0))) || !(obtenerDigito(cuenta.val()) ==
                        parseInt(dc.val().charAt(1)))) {
                    setError();
                    return false;
                } else {
                    return true;
                }
            }

            function obtenerDigito(valor) {
                valores = new Array(1, 2, 4, 8, 5, 10, 9, 7, 3, 6);
                control = 0;
                for (i = 0; i <= 9; i++)
                    control += parseInt(valor.charAt(i)) * valores[i];
                control = 11 - (control % 11);
                if (control == 11) control = 0;
                else if (control == 10) control = 1;
                return control;
            }

            function setError() {
                $('.cuenta').addClass('invalid');
            }
        }
    }

    Polymer({

        is: 'num-cuenta',

        properties: {
            label: {
                type: String,
                value: 'NÃºmero de cuenta:'
            },
            entidad: {
                type: String,
                observer: '_onEntidadChanged'
            },
            oficina: {
                type: String,
                observer: '_onOficinaChanged'
            },
            dc: {
                type: String,
                observer: '_onDcChanged'
            },
            cuenta: {
                type: String,
                observer: '_onCuentaChanged'
            }
        },
        ready: function () {
            console.log('Component ready');
            $('.cuenta').autotab('cuenta', 'filter', 'number');
        },
        _onEntidadChanged: function (newValue, oldValue) {
            _validarCampo(0, newValue, 4);
        },
        _onOficinaChanged: function (newValue, oldValue) {
            _validarCampo(1, newValue, 4);
        },
        _onDcChanged: function (newValue, oldValue) {
            _validarCampo(2, newValue, 2);
        },
        _onCuentaChanged: function (newValue, oldValue) {
            _validarCampo(3, newValue, 10);
        }
    });

</script>
</body>
</html>
