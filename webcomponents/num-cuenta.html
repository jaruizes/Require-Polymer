<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
<dom-module id="num-cuenta">

    <style>
        input.invalid {
            border:1px solid #f00;
        }
    </style>

    <template>
        <div id="numcuentacomponent">
            <label>{{label}}</label>
            <input type="text" id="entidad" class="cuenta" size="4" maxlength="4" placeholder="1234"
                   value="{{entidad::blur}}">&nbsp;
            <input type="text" id="oficina" class="cuenta" size="4" maxlength="4" placeholder="1234"
                   value="{{oficina::blur}}">&nbsp;
            <input type="text" id="dc" class="cuenta" size="2" maxlength="2" placeholder="12"
                   value="{{dc::blur}}">&nbsp;
            <input type="text" id="numcuenta" class="cuenta" size="10" maxlength="10" placeholder="1234567890"
                   value="{{cuenta::blur}}">
        </div>
        <div id="msg"></div>

    </template>


</dom-module>

<script>
    function validarCCC(entidad, sucursal, dc, cuenta) {
        if (entidad && sucursal && dc && cuenta) {
            if (!(_obtenerDigito("00" + entidad + sucursal) ==
                    parseInt(dc.charAt(0))) || !(_obtenerDigito(cuenta) ==
                    parseInt(dc.charAt(1)))) {
                return false;
            } else {
                return true;
            }
        }

        function _obtenerDigito(valor) {
            valores = new Array(1, 2, 4, 8, 5, 10, 9, 7, 3, 6);
            control = 0;
            for (i = 0; i <= 9; i++)
                control += parseInt(valor.charAt(i)) * valores[i];
            control = 11 - (control % 11);
            if (control == 11) control = 0;
            else if (control == 10) control = 1;
            return control;
        }
    }

    Polymer({

        is: 'num-cuenta',

        properties: {
            label: {
                type: String,
                value: 'NÃºmero de cuenta:'
            },
            entidad: {
                type: String,
                observer: '_onEntidadChanged'
            },
            oficina: {
                type: String,
                observer: '_onOficinaChanged'
            },
            dc: {
                type: String,
                observer: '_onDcChanged'
            },
            cuenta: {
                type: String,
                observer: '_onCuentaChanged'
            }
        },
        ready: function () {
            console.log('Component ready');
            this.fieldsOK = [false, false, false, false];
            $('.cuenta').autotab('cuenta', 'filter', 'number');
        },
        _onEntidadChanged: function (newValue, oldValue) {
            this._validarCampo(0, newValue, 4);
        },
        _onOficinaChanged: function (newValue, oldValue) {
            this._validarCampo(1, newValue, 4);
        },
        _onDcChanged: function (newValue, oldValue) {
            this._validarCampo(2, newValue, 2);
        },
        _onCuentaChanged: function (newValue, oldValue) {
            this._validarCampo(3, newValue, 10);
        },
        _validarCampo: function (fieldId, value, maxlength) {
            this.fieldsOK[fieldId] = value && value.length == maxlength && !isNaN(value);
            if (this.fieldsOK[0] && this.fieldsOK[1] && this.fieldsOK[2] && this.fieldsOK[3]) {
                if (!validarCCC(this.$.entidad.value, this.$.oficina.value, this.$.dc.value, this.$.numcuenta.value)) {
                    var els = Polymer.dom(this.root).querySelectorAll('.cuenta');
                    for (var i = 0; i < els.length; i++) {
                        els[i].className += ' invalid';
                    }
                }
            }
        }
    });

</script>
</body>
</html>
